# Copilot Instructions for LifeOS

- **Projects present**: main frontend lives in [lifeos/src](lifeos/src) (React 18 + Vite 3, PWA only in prod); there is an older minimalist UI in [src](src) that still uses Dexie but no routing. Prioritize the `lifeos` app unless told otherwise.
- **Run frontend**: from `lifeos/` run `npm install` then `npm run dev` (defaults to 5173 and clears service workers in dev via [lifeos/src/main.tsx](lifeos/src/main.tsx#L5-L25)). Build with `npm run build`.
- **Backend (AI + finance orchestrator)**: [lifeos_backend/main.py](lifeos_backend/main.py) is the active FastAPI server. Frontend expects it on `http://localhost:8001` for `/chat` and `/financeiro`; start with `uvicorn main:app --reload --port 8001`. Requires `.env` with `OPENROUTER_API_KEY`. CORS allows 5173 only.
- **Fallback test server**: [test_server.py](test_server.py) is a simpler FastAPI server already bound to port 8001 (used by the finance UI). It persists to `lifeos_state.json` and `financeiro_history.json` and exposes `/health`, `/financeiro`, `/financeiro/historico`, `/chat`.
- **Data storage (frontend)**: Local IndexedDB via Dexie v6 schema in [lifeos/src/shared/db.ts](lifeos/src/shared/db.ts). Tables: `tasks`, `habits`, `calendar`, `routines`, `financeiro` (singleton). Call `initFinanceiro()` once before reading finance state. `cleanupRoutines()` aggressively deletes unconfirmed chat routines and very-short/test entries and is invoked at app start.
- **AI calls (frontend)**: Use [lifeos/src/shared/ai/ai.ts](lifeos/src/shared/ai/ai.ts) or [lifeos/src/services/ai.ts](lifeos/src/services/ai.ts); both POST to `http://localhost:8001/chat` and never hold API keys. `ChatPage` builds context (today routines/tasks/events) before calling the backend and fires `lifeosStateUpdated` after responses ([lifeos/src/features/chat/ChatPage.tsx](lifeos/src/features/chat/ChatPage.tsx#L27-L138)).
- **Finance UI**: [lifeos/src/features/controle/ControlePage.tsx](lifeos/src/features/controle/ControlePage.tsx) polls `GET /financeiro` every 5s on port 8001 and displays debts and phase. Navigation buttons route to chat for plan adjustments.
- **Auth & routing**: App is wrapped by [lifeos/src/shared/AuthContext.tsx](lifeos/src/shared/AuthContext.tsx) and gated in [lifeos/src/App.tsx](lifeos/src/App.tsx). `useAuth` hits backend `/auth/login|logout|me` with sessionStorage token `lifeos:token`. The file contains an old stub plus the real implementation; do not delete the lower block without cleaning imports.
- **Layout & navigation**: Authenticated routes live under [lifeos/src/layouts/LifeOSLayout.tsx](lifeos/src/layouts/LifeOSLayout.tsx) using `react-router-dom` v7. Sidebar navigation is in [lifeos/src/components/SimpleSidebar.tsx](lifeos/src/components/SimpleSidebar.tsx) and depends on `useAuth.logout()`. Some UI listens to `CustomEvent("app:navigate")`; keep those event names stable if adding features.
- **Tone and passive insights**: User-selectable tone persisted in [lifeos/src/shared/tone.ts](lifeos/src/shared/tone.ts) and drives messaging. Deterministic insights come from [lifeos/src/shared/insights](lifeos/src/shared/insights/index.ts); they read Dexie data only (no AI) and are surfaced in [lifeos/src/components/ui/PassiveChatPanel.tsx](lifeos/src/components/ui/PassiveChatPanel.tsx).
- **Global UI patterns**: Theme stored in `localStorage lifeos-theme` and applied to `document.body.dataset.theme` in layout/App files. Toasts are global via [lifeos/src/shared/useToast.ts](lifeos/src/shared/useToast.ts) and rendered at layout level; use `useToast().showToast` instead of ad-hoc alerts.
- **Events to refresh state**: `ChatPage` emits `lifeosStateUpdated` after AI replies; PassiveChat triggers `app:focusPriority` and `app:navigate` when suggesting actions. Respect these hooks instead of polling where possible.
- **Persistence files (backend)**: `memory.json` stores chat summaries; `financeiro.json` and `financial_conversation_state.json` hold finance strategy state for orchestrator in [lifeos_backend/main.py](lifeos_backend/main.py#L27-L139). Deleting these resets memory/finance.
- **Testing**: No JS test suite configured. Python side has lightweight scripts (e.g., `python test_server.py`) to exercise finance endpoints; install `fastapi`, `uvicorn`, `python-multipart`, `httpx`, `python-dotenv` as needed.
- **Non-obvious gotchas**: Frontend expects backend port 8001, while the backend README mentions 8000—align ports or update fetch URLs together. Auth endpoints `/auth/*` are assumed but not implemented in `lifeos_backend/main.py`; stubbing them in tests may be required. Avoid removing Portuguese strings—they are user-facing.
